stages:
    - build
    - deploy

cache:
    paths:
        - node/frontend/node_modules/
        - node/backend/node_modules/
        - node/common/node_modules/

build:frontend:
    stage: build
    only:
        - merge_requests
    script:
        - cd node/common/
        - npm install
        - cd ../../node/frontend/
        - npm install
        - npm run build
        
build:backend:
    stage: build
    only:
        - merge_requests
    script:
        - cd node/common/
        - npm install
        - cd ../../node/backend/
        - npm install
        - npm run build

deploy_test:
  stage: deploy
  variables:  
    AWS_PROFILE: h2x-gitlab-runner-test-profile
    env: test
  script:
    - echo "Deploy $CI_COMMIT_BRANCH branch to $env"
    - sudo -E -u gitlab-runner ./cloudformation/deploy.sh
  after_script:
    - sudo -E -u gitlab-runner ./cloudformation/clean.sh
  environment:
    name: test
    url: https://app-test.h2xtesting.com
  only:
    - test
    - /^test-.*$/

deploy_stage:
  stage: deploy
  variables:  
    AWS_PROFILE: h2x-gitlab-runner-test-profile
    env: stage
  script:
    - echo "Deploy $CI_COMMIT_BRANCH branch to $env"
    - sudo -E -u gitlab-runner ./cloudformation/deploy.sh
  after_script:
    - sudo -E -u gitlab-runner ./cloudformation/clean.sh
  environment:
    name: stage
    url: https://app-stage.h2xtesting.com
  only:
    - /^release-.*$/

deploy_prod:
  stage: deploy
  variables:
    AWS_PROFILE: h2x-gitlab-runner-prod-profile
    env: prod
  script:    
    - echo "Deploy $CI_COMMIT_TAG branch to PRODUCTION. Initiated manually."
    - sudo -E -u gitlab-runner ./cloudformation/deploy.sh
  after_script:
    - sudo -E -u gitlab-runner ./cloudformation/clean.sh
  environment:
    name: prod
    url: https://app.h2xengineering.com
  only:
    - tags
  when: manual

