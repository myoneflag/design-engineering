# Copy PDF and renders from Production account to Test account

This procedure details how to copy files from S3 buckets in Production account to testing account S3 buckets.

Production account Source buckets:
* h2x-pdf
* h2x-pdr-renders  

Production account Destination buckets:
* h2x-s3-pdf-stage
* h2x-s3-pdfrenders-stage

### 1. Attach Bucket Policy
(If not already done)

See https://aws.amazon.com/premiumsupport/knowledge-center/cross-account-access-s3/ for more info on the following settings.

For each destination bucket attach bucket policy allowing all entities in Production account to manage s3 buckets in Testing account.

```
{
    "Version": "2012-10-17",
    "Id": "PolicyPdfBucket",
    "Statement": [
        {
            "Sid": "AllowProductionS3AccesInTestingAccount",
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::285736176239:root"
            },
            "Action": "s3:*",
            "Resource": [
                "arn:aws:s3:::h2x-s3-pdf-stage",
                "arn:aws:s3:::h2x-s3-pdf-stage/*"
            ]
        }
    ]
}
```

```
{
    "Version": "2012-10-17",
    "Id": "PolicyPdfRendersBucket",
    "Statement": [
        {
            "Sid": "AllowProductionS3AccesInTestingAccount",
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::285736176239:root"
            },
            "Action": "s3:*",
            "Resource": [
                "arn:aws:s3:::h2x-s3-pdfrenders-stage",
                "arn:aws:s3:::h2x-s3-pdfrenders-stage/*"
            ]
        }
    ]
}
```

### 2. Disable PDF Bucket trigger for renderere lambda function
(Optional)
Go to S3 > `h2x-s3-pdf-stage` > Properties tab > Event Notifications and disable trigger for `pdf-renderer-stage` lambda function. Disable by editing trigger to change suffix from `pdf` to `_pdf_`.

> ! If the number of PDF files to be copied is large, then failing to do so will trigger the lambda function thousands of times, incurring costs.

### 3. Perform file sync of buckets

* Log into Production account
* Open CloudShell
* Run following AWS commands, first in dryrun, then for effect

```
aws s3 sync s3://h2x-pdf s3://h2x-s3-pdf-stage --acl bucket-owner-full-control --dryrun
```

```
aws s3 sync s3://h2x-pdf-renders s3://h2x-s3-pdfrenders-stage --acl bucket-owner-full-control --dryrun
```
If you do not disable the PDF lambda trigger, tgen this is not required, since the rendered images will be generated by the lambda.

For a progress, you can run in a new CloudShell window commands like 
```
aws s3 sync s3://source s3://destination --dryrun | wc -l
```
that will return tnumber of files that still need to be copied.

### 4. Re-enable PDF trigger
Change trigger suffix back to `pdf`.

### 5. Test
Assuming the database of the testing environment is a fresh backup form production, any project opened will show background images.

To restore a production backup to a test environment, read [here](./restore-production-backup-to-a-test-environment.md).
