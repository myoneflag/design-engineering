version: '3.2'

services:
    # Postgres DB instance
    # hostname: db
    db:
        image: postgres
        restart: always
        environment:
            - POSTGRES_PASSWORD=postgres
            - POSTGRES_DB=h2x
            - POSTGRES_USER=postgres
        ports:
            - 5432:5432

    # ActiveMQ instance
    # hostname: mq
    mq:
        image: webcenter/activemq
        restart: always
        environment: 
            - ACTIVEMQ_ADMIN_LOGIN=admin
            - ACTIVEMQ_ADMIN_PASSWORD=admin
        ports:
            - 8161:8161
            - 61614:61614 #default WS transport protocol port open
    
    sqs:
        image: softwaremill/elasticmq-native
        restart: always        
        ports:
            - 9324:9324
            - 9325:9325
        environment:
            - AWS_ACCESS_KEY_ID=fake
            - AWS_SECRET_ACCESS_KEY=fake
        volumes: 
            - ./sqs.conf:/opt/elasticmq.conf

    sqsd:
        image: mogadanez/sqsd
        environment:
            - SQSD_WORKER_HTTP_URL=http://worker:8013/workermessage
            - SQSD_QUEUE_URL=http://sqs:9324/queue/h2x-worker-queue
            - SQSD_SSL_ENABLED=false
            - SQSD_RUN_DAEMONIZED=1
            - SQSD_MAX_MESSAGES_PER_REQUEST=1
            - AWS_ACCESS_KEY_ID=fake
            - AWS_SECRET_ACCESS_KEY=fake


    backend:
        profiles:
            - dev
        build: 
            context: ../node/
            dockerfile: ../docker/dev-backend.Dockerfile
            args:
                - AWS_KEY=${AWS_KEY}
                - AWS_SECRET=${AWS_SECRET}
        image: 'h2x-dev-backend:latest'
        restart: always
        depends_on:
            - db
        ports:
            - 8012:80
        volumes:
            # anonymous volumes to prevent container folders being overwritten by host folders
            # - /usr/src/app/node_modules
            # - /usr/src/app/backend/node_modules
            # - /usr/src/app/backend/dist
            # current code as bind volume
            - ../node/:/usr/src/app/

    frontend:
        profiles:
            - dev
        build:
            context: ../node/
            dockerfile: ../docker/dev-frontend.Dockerfile
        image: 'h2x-dev-frontend:latest'
        restart: always
        ports:
            - 8011:80
        volumes:
            # anonymous volumes to prevent container folders being overwritten by host folders
            # - /usr/src/app/node_modules
            # - /usr/src/app/frontend/node_modules
            # - /usr/src/app/frontend/dist
            # current code as bind volume
            - ../node/:/usr/src/app/

    worker:
        profiles:
            - dev
        build: 
            context: ../node/
            dockerfile: ../docker/dev-worker.Dockerfile
            args:
                - AWS_KEY=${AWS_KEY}
                - AWS_SECRET=${AWS_SECRET}
        image: 'h2x-dev-worker:latest'
        restart: always
        depends_on:
            - db
        ports:
            - 8013:80
        volumes:
            # anonymous volumes to prevent container folders being overwritten by host folders
            # - /usr/src/app/node_modules
            # - /usr/src/app/backend/node_modules
            # - /usr/src/app/backend/dist
            # current code as bind volume
            - ../node/:/usr/src/app/

    prod-web:
        profiles:
            - prod
        build:
            context: ../node/
            dockerfile: ../docker/prod-web.Dockerfile
        image: 'h2x-prod-web:latest'
        restart: always
        ports:
            - 80:80

    prod-worker:
        profiles:
            - prod
        build: 
            context: ../node/
            dockerfile: ../docker/prod-worker.Dockerfile
            args:
                - AWS_KEY=${AWS_KEY}
                - AWS_SECRET=${AWS_SECRET}
        image: 'h2x-prod-worker:latest'
        restart: always
        ports:
            - 8013:80

    nginx:
        profiles:
          - dev
        image: 'nginx:latest'
        volumes:
            - ./nginx.conf:/etc/nginx/nginx.conf
        ports:
            - 8010:80
        depends_on:
            - backend
            - frontend
